<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sicars Contrato de Alquiler de Coches</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; line-height: 1.6; background-color: #f8f9fa; color: #333; }
  .container { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
  h2 { color: #007BFF; margin-bottom: 20px; text-align: center; border-bottom: 2px solid #007BFF; padding-bottom: 10px; }
  h3 { color: #0056b3; margin: 20px 0 15px; padding-bottom: 5px; border-bottom: 1px solid #ddd; }
  label { display: block; margin: 15px 0 8px; font-weight: 600; }
  input, select { padding: 12px; width: 100%; max-width: 400px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
  button { margin-top: 15px; padding: 14px 20px; cursor: pointer; border: none; border-radius: 5px; font-size: 16px; font-weight: 600; transition: all 0.3s ease; }
  .blue-btn { background: #007BFF; color: #fff; }
  .blue-btn:hover { background: #0056b3; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
  .red-btn { background: #FF4136; color: #fff; margin-top: 20px; }
  .red-btn:hover { background: #c12b1f; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

  .contract { border: 1px solid #ccc; padding: 25px; margin-top: 25px; font-size: 15px; border-radius: 8px; background: #fff; }
  .contract p { margin: 10px 0; }
  #signatureModal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; }
  .modal-content { background: #fff; padding: 25px; border-radius: 10px; text-align: center; max-width: 500px; width: 95%; box-shadow: 0 5px 25px rgba(0,0,0,0.3); }
  #signatureCanvas { border: 2px solid #007BFF; width: 100%; height: 200px; touch-action: none; border-radius: 5px; background: #f9f9f9; }
  .two-columns { display: flex; justify-content: flex-start; margin-top: 20px; gap: 40px; flex-wrap: wrap; }
  .col { width: 100%; max-width: 400px; }

  /* Signature block */
  .signature-container { margin: 25px 0; padding: 20px; border: 2px dashed #007BFF; border-radius: 8px; text-align: center; background: #f0f8ff; }
  .signature-preview-container { position: relative; margin: 20px 0; min-height: 120px; display: flex; justify-content: center; }
  #signaturePreview { border: 1px solid #aaa; display: block; margin: 0 auto; max-width: 100%; background-color: white; border-radius: 5px; width: 350px; height: 120px; }
  .signature-btn { padding: 16px 30px; font-size: 18px; margin: 15px auto; display: block; width: 100%; max-width: 350px; }
  .signature-instruction { color: #666; font-style: italic; margin-top: 10px; }

  /* Language flag buttons */
  .translation-buttons { display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0 5px; }
  .flag-btn {
    background: none;
    border: 2px solid transparent;
    border-radius: 8px;
    font-size: 34px;
    line-height: 1;
    padding: 6px 10px;
    cursor: pointer;
    transition: transform .2s, box-shadow .2s, border-color .2s, background-color .2s;
    position: relative;
  }
  .flag-btn:hover {
    transform: translateY(-3px) scale(1.07);
    box-shadow: 0 6px 14px rgba(0,0,0,0.18);
  }
  .flag-btn.active {
    border-color: #007BFF;
    box-shadow: 0 0 0 4px rgba(0,123,255,0.25);
    background-color: #e7f2ff;
  }
  .flag-btn:focus-visible {
    outline: 3px solid #80bdff;
    outline-offset: 2px;
  }

  @media (max-width: 480px) {
    .flag-btn { font-size: 30px; padding: 4px 8px; }
  }

  @media (max-width: 768px) {
    body { margin: 10px; }
    .container { padding: 15px; }
    .two-columns { gap: 20px; }
    input, select { max-width: 100%; }
    .contract { padding: 15px; }
    .signature-container { padding: 15px; }
    #signaturePreview { width: 100%; height: 100px; }
  }
  @media (max-width: 480px) {
    button:not(.flag-btn) { width: 100%; }
    .modal-content { padding: 15px; width: 95%; }
    .signature-btn { padding: 14px 20px; font-size: 16px; }
  }

  input:focus, select:focus { outline: none; border-color: #007BFF; box-shadow: 0 0 0 3px rgba(0,123,255,0.25); }
  .modal-content button { margin: 10px 5px; padding: 10px 15px; display: inline-block; width: auto; }
  .success-message { color: #28a745; font-weight: 600; text-align: center; margin-top: 10px; }
  .optional { color: #6c757d; font-weight: normal; font-size: 0.9em; }
  .required-field::after { content: " *"; color: #FF4136; }
  .language-option { display: none; }
  .language-option.active { display: block; }

  .loading-spinner { display: none; border: 4px solid #f3f3f3; border-top: 4px solid #007BFF; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .email-status { text-align: center; padding: 10px; margin: 10px 0; border-radius: 5px; display: none; }
  .email-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
  .email-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
  .email-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
</style>
</head>
<body>

<div class="container">
  <div id="formSection">
    <h2 data-es="Crear Contrato" data-sv="Skapa Kontrakt" data-en="Create Contract">Crear Contrato</h2>
    
    <label class="required-field" data-es="Nombre del Cliente:" data-sv="Kundens Namn:" data-en="Client Name:">Nombre del Cliente:</label>
    <input type="text" id="clientName" placeholder="Ingrese nombre completo" required>

    <label class="required-field" data-es="Número de Teléfono:" data-sv="Telefonnummer:" data-en="Phone Number:">Número de Teléfono:</label>
    <input type="tel" id="phone" pattern="[0-9]+" placeholder="Solo números (ej. 123456789)" required>

    <label data-es="Licencia de Conducir:" data-sv="Körkort:" data-en="Driving License:">Licencia de Conducir: <span class="optional" data-es="(opcional)" data-sv="(valfri)" data-en="(optional)">(opcional)</span></label>
    <input type="text" id="license" placeholder="Ingrese número de licencia">

    <label data-es="Marca del Coche:" data-sv="Bilmärke:" data-en="Car Brand:">Marca del Coche: <span class="optional" data-es="(opcional)" data-sv="(valfri)" data-en="(optional)">(opcional)</span></label>
    <input type="text" id="brand" placeholder="Ingrese marca y modelo">

    <label data-es="Número de Matrícula:" data-sv="Registreringsnummer:" data-en="Plate Number:">Número de Matrícula: <span class="optional" data-es="(opcional)" data-sv="(valfri)" data-en="(optional)">(opcional)</span></label>
    <input type="text" id="plate" placeholder="Ingrese número de matrícula">

    <label data-es="Unidades:" data-sv="Enheter:" data-en="Units:">Unidades: <span class="optional" data-es="(opcional)" data-sv="(valfri)" data-en="(optional)">(opcional)</span></label>
    <select id="units">
      <option value="1" selected>1</option><option value="2">2</option><option value="3">3</option>
      <option value="4">4</option><option value="5">5</option><option value="6">6</option>
      <option value="7">7</option><option value="8">8</option><option value="9">9</option>
    </select>

    <label data-es="Fecha Desde:" data-sv="Datum Från:" data-en="Date From:">Fecha Desde: <span class="optional" data-es="(opcional)" data-sv="(valfri)" data-en="(optional)">(opcional)</span></label>
    <input type="date" id="from">

    <label data-es="Fecha Hasta:" data-sv="Datum Till:" data-en="Date To:">Fecha Hasta: <span class="optional" data-es="(opcional)" data-sv="(valfri)" data-en="(optional)">(opcional)</span></label>
    <input type="date" id="to">

    <label data-es="IVA:" data-sv="Moms:" data-en="VAT:">IVA: <span class="optional" data-es="(opcional)" data-sv="(valfri)" data-en="(optional)">(opcional)</span></label>
    <input type="number" id="iva" pattern="[0-9]*" placeholder="Ingrese importe de IVA" onkeypress="return event.charCode >= 48 && event.charCode <= 57">

    <label data-es="Coste Total:" data-sv="Total Kostnad:" data-en="Total Cost:">Coste Total: <span class="optional" data-es="(opcional)" data-sv="(valfri)" data-en="(optional)">(opcional)</span></label>
    <input type="number" id="total" pattern="[0-9]*" placeholder="Ingrese coste total" onkeypress="return event.charCode >= 48 && event.charCode <= 57">

    <button class="blue-btn" onclick="generateContract()" data-es="Generar Contrato" data-sv="Generera Kontrakt" data-en="Generate Contract">Generar Contrato</button>
  </div>

  <div id="contractSection" style="display:none;">
    <h2 data-es="Sicars Contrato de Alquiler de Coches" data-sv="Sicars Biluthyrningsavtal" data-en="Sicars Car Rental Contract">Sicars Contrato de Alquiler de Coches</h2>
    <div class="contract" id="contractContent">

      <p><strong data-es="NIF/CIF:" data-sv="NIF/CIF:" data-en="NIF/CIF:">NIF/CIF:</strong> B72700586</p>
      <p><strong data-es="NOMBRE:" data-sv="NAMN:" data-en="NAME:">NOMBRE:</strong> SIMON ABBOUD</p>
      <p><strong data-es="NIE:" data-sv="NIE:" data-en="NIE:">NIE:</strong> Y-6074507-Z</p>
      <p><strong data-es="Dirección:" data-sv="Adress:" data-en="Address:">Dirección:</strong> Calle Antonio Ruiz Corces 31</p>
      <p><strong data-es="Teléfono office:" data-sv="Kontorstelefon:" data-en="Office Phone:">Teléfono office:</strong> +34642482422</p>
      <p><strong data-es="Simón:" data-sv="Simón:" data-en="Simón:">Simón:</strong> +46735043440</p>

      <h3 data-es="Contrato de Alquiler" data-sv="Uthyrningsavtal" data-en="Rental Contract">Contrato de Alquiler</h3>

      <div class="two-columns">
        <div class="col">
          <p><strong data-es="Cliente:" data-sv="Kund:" data-en="Client:">Cliente:</strong> <span id="showClientName"></span></p>
          <p><strong data-es="Teléfono:" data-sv="Telefon:" data-en="Phone:">Teléfono:</strong> <span id="showPhone"></span></p>
          <p><strong data-es="Licencia:" data-sv="Körkort:" data-en="License:">Licencia:</strong> <span id="showLicense"></span></p>
          <p><strong data-es="Marca del Coche:" data-sv="Bilmärke:" data-en="Car Brand:">Marca del Coche:</strong> <span id="showBrand"></span></p>
          <p><strong data-es="Matrícula:" data-sv="Registreringsnummer:" data-en="Plate:">Matrícula:</strong> <span id="showPlate"></span></p>
        </div>

        <div class="col">
          <p><strong data-es="Unidades:" data-sv="Enheter:" data-en="Units:">Unidades:</strong> <span id="showUnits"></span></p>
          <p><strong data-es="Desde:" data-sv="Från:" data-en="From:">Desde:</strong> <span id="showFrom"></span></p>
          <p><strong data-es="Hasta:" data-sv="Till:" data-en="To:">Hasta:</strong> <span id="showTo"></span></p>
          <p><strong data-es="IVA:" data-sv="Moms:" data-en="VAT:">IVA:</strong> <span id="showIVA"></span> €</p>
          <p><strong data-es="Total:" data-sv="Totalt:" data-en="Total:">Total:</strong> <span id="showTotal"></span> €</p>
        </div>
      </div>

      <!-- FLAG STYLE LANGUAGE SWITCH -->
      <div class="translation-buttons">
        <button class="flag-btn active" data-lang-btn="es" onclick="changeLanguage('es')" aria-label="Español">🇪🇸</button>
        <button class="flag-btn" data-lang-btn="sv" onclick="changeLanguage('sv')" aria-label="Svenska">🇸🇪</button>
        <button class="flag-btn" data-lang-btn="en" onclick="changeLanguage('en')" aria-label="English">🇬🇧</button>
      </div>

      <h3 data-es="Términos y Condiciones" data-sv="Villkor" data-en="Terms & Conditions">Términos y Condiciones</h3>
      
      <div class="language-option active" data-lang="es">
        <p><strong>Uso del vehículo:</strong> El vehículo no se utilizará con fines ilegales ni se conducirá bajo la influencia de drogas o alcohol.</p>
        <p><strong>Límite de edad:</strong> El inquilino confirma que tiene al menos 23 años. Los inquilinos menores de 23 años no son elegibles para alquilar ni conducir el automóvil.</p>
        <p><strong>Licencia de conducir:</strong> El inquilino debe tener una licencia de conducir válida y estar preparado para mostrarla en el momento del alquiler.</p>
        <p><strong>Restricciones geográficas:</strong> El arrendatario acepta que el vehículo sólo puede circular dentro de un radio de 250 km desde Torrevieja, España. Si desea circular fuera de esta zona, deberá obtener autorización previa por escrito.</p>
        <p><strong>Política de devolución:</strong> El vehículo debe devolverse en la fecha de finalización especificada en las mismas condiciones en que se recibió, excluyendo el desgaste normal. Las devoluciones tardías pueden estar sujetas a cargos adicionales.</p>
        <p><strong>Responsabilidad por Daños:</strong> Si el vehículo es conducido por un conductor menor de 23 años, ese conductor será personalmente responsable de cualquier daño al vehículo de alquiler y de cualquier daño a terceros.</p>
      </div>

      <div class="language-option" data-lang="sv">
        <p><strong>Användning av fordonet:</strong> Fordonet får inte användas för olagliga ändamål eller köras under påverkan av droger eller alkohol.</p>
        <p><strong>Åldersgräns:</strong> Kunden bekräftar att han/hon är minst 23 år gammal. Kunder under 23 år är inte berättigade att hyra eller köra bilen.</p>
        <p><strong>Körkort:</strong> Kunden måste ha ett giltigt körkort och vara beredd att visa upp det vid uthyrningstillfället.</p>
        <p><strong>Geografiska begränsningar:</strong> Kunden accepterar att fordonet endast får köras inom en radie av 250 km från Torrevieja, Spanien. Om du vill köra utanför detta område måste du först få skriftligt tillstånd.</p>
        <p><strong>Återlämningspolicy:</strong> Fordonet måste återlämnas på det angivna slutdatumet i samma skick som det mottogs, exklusive normalt slitage. Sena återlämningar kan medföra extra avgifter.</p>
        <p><strong>Ansvar för skador:</strong> Om fordonet körs van en förare under 23 år, är den föraren personligt ansvarig för eventuella skador på hyrbilen och eventuella skador på tredje part.</p>
      </div>

      <div class="language-option" data-lang="en">
        <p><strong>Vehicle use:</strong> The vehicle will not be used for illegal purposes or driven under the influence of drugs or alcohol.</p>
        <p><strong>Age limit:</strong> The customer confirms that they are at least 23 years old. Customers under 23 years old are not eligible to rent or drive the car.</p>
        <p><strong>Driver's license:</strong> The customer must have a valid driver's license and be prepared to show it at the time of rental.</p>
        <p><strong>Geographical restrictions:</strong> The customer accepts that the vehicle may only be driven within a radius of 250 km from Torrevieja, Spain. If you wish to drive outside this area, you must first obtain written authorization.</p>
        <p><strong>Return policy:</strong> The vehicle must be returned on the specified end date in the same condition as it was received, excluding normal wear and tear. Late returns may be subject to additional charges.</p>
        <p><strong>Liability for damages:</strong> If the vehicle is driven by a driver under 23 years of age, that driver will be personally responsible for any damage to the rental vehicle and any damage to third parties.</p>
      </div>

      <h3 data-es="Aceptación de Términos" data-sv="Godkännande av Villkor" data-en="Acceptance of Terms">Aceptación de Términos</h3>
      <p data-es="Al firmar a continuación, ambas partes reconocen y aceptan todos los términos y condiciones de este contrato." data-sv="Genom att underteckna nedan erkänner och accepterar båda parter alla villkor i detta avtal." data-en="By signing below, both parties acknowledge and accept all terms and conditions of this contract.">Al firmar a continuación, ambas partes reconocen y aceptan todos los términos y condiciones de este contrato.</p>
      
      <div class="signature-container">
        <p><strong data-es="Firma del Cliente" data-sv="Kundens Namnteckning" data-en="Client Signature">Firma del Cliente</strong></p>
        <p class="signature-instruction" data-es="Por favor, firme en el recuadro inferior" data-sv="Vänligen signera i rutan nedan" data-en="Please sign in the box below">Por favor, firme en el recuadro inferior</p>
        <div class="signature-preview-container">
          <canvas id="signaturePreview"></canvas>
        </div>
        <button class="blue-btn signature-btn" onclick="openSignature()" data-es="✍️ Haga clic aquí para firmar" data-sv="✍️ Klicka här för att signera" data-en="✍️ Click here to sign">✍️ Haga clic aquí para firmar</button>
        <p id="signedStatus" class="success-message" style="display:none;" data-es="✔ Firma capturada correctamente" data-sv="✔ Signatur har sparats" data-en="✔ Signature captured successfully">✔ Firma capturada correctamente</p>
      </div>

      <label data-es="Ingrese su email para recibir el contrato:" data-sv="Ange din e-post för att få kontraktet:" data-en="Enter your email to receive the contract:">Ingrese su email para recibir el contrato:</label>
      <input type="email" id="clientEmail" placeholder="su@email.com">
      
      <div class="loading-spinner" id="emailLoading"></div>
      <div class="email-status" id="emailSuccess">
        <p data-es="✔ Contrato enviado correctamente. Por favor, revise su carpeta de correo no deseado si no puede encontrarlo en su bandeja de entrada." 
           data-sv="✔ Kontrakt skickat! Kontrollera din skräppost om du inte hittar det i inkorgen." 
           data-en="✔ Contract sent successfully! Please check your junk mail folder if you can't find it in your inbox.">
           ✔ Contrato enviado correctamente. Por favor, revise su carpeta de correo no deseado si no puede encontrarlo en su bandeja de entrada.
        </p>
      </div>
      <div class="email-status email-error" id="emailError">
        <p data-es="✗ Error al enviar el contrato. Por favor, inténtelo de nuevo." 
           data-sv="✗ Fel vid sändning av kontrakt. Försök igen." 
           data-en="✗ Failed to send contract. Please try again.">
           ✗ Error al enviar el contrato. Por favor, inténtelo de nuevo.
        </p>
      </div>
      
      <button class="blue-btn" onclick="sendEmail()" data-es="Enviar Contrato por Email" data-sv="Skicka Kontrakt via E-post" data-en="Send Contract via Email">Enviar Contrato por Email</button>
      <button class="red-btn" onclick="downloadPDF()" data-es="Descargar Contrato como PDF" data-sv="Ladda ner Kontrakt som PDF" data-en="Download Contract as PDF">Descargar Contrato como PDF</button>
      <button class="blue-btn" style="margin-top:25px; background:#17a2b8" onclick="goBackToForm()" data-es="Volver al Formulario" data-sv="Tillbaka till Formulär" data-en="Back to Form">Volver al Formulario</button>
    </div>
  </div>
</div>

<!-- Signature Modal -->
<div id="signatureModal">
  <div class="modal-content">
    <h3 data-es="Dibuje Su Firma" data-sv="Rita Din Namnteckning" data-en="Draw Your Signature">Dibuje Su Firma</h3>
    <p class="signature-instruction" data-es="Dibuje su firma en el recuadro inferior" data-sv="Rita din namnteckning i rutan nedan" data-en="Draw your signature in the box below">Dibuje su firma en el recuadro inferior</p>
    <canvas id="signatureCanvas"></canvas><br>
    <button class="blue-btn" onclick="clearSignature()" data-es="Borrar" data-sv="Radera" data-en="Clear">Borrar</button>
    <button class="blue-btn" onclick="saveSignature()" data-es="Guardar Firma" data-sv="Spara Namnteckning" data-en="Save Signature">Guardar Firma</button>
    <button class="red-btn" onclick="closeSignature()" data-es="Cancelar" data-sv="Avbryt" data-en="Cancel">Cancelar</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
emailjs.init("Ct10aXWOv0UiEYTK42");

let canvas, ctx, drawing = false, signatureData = null;
let currentLanguage = 'es';

/* URL / routing additions from previous version */
function buildContractSlug(name) {
  return (name || 'contrato').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
}
function updateUrl(clientName) {
  const slug = buildContractSlug(clientName);
  const params = new URLSearchParams(window.location.search);
  params.set('contract', slug);
  history.pushState({ contract: true, slug }, '', window.location.pathname + '?' + params.toString());
}
function clearContractUrl() {
  const params = new URLSearchParams(window.location.search);
  if (params.has('contract')) {
    params.delete('contract');
    history.pushState({ contract: false }, '', window.location.pathname + (params.toString() ? '?' + params.toString() : ''));
  }
}
function goBackToForm() {
  signatureData = null;
  document.getElementById("contractSection").style.display = "none";
  document.getElementById("formSection").style.display = "block";
  clearContractUrl();
}

window.addEventListener('popstate', function() {
  const params = new URLSearchParams(window.location.search);
  if (params.has('contract')) {
    document.getElementById("formSection").style.display = "none";
    document.getElementById("contractSection").style.display = "block";
  } else {
    document.getElementById("contractSection").style.display = "none";
    document.getElementById("formSection").style.display = "block";
  }
});

document.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(window.location.search);
  if (params.has('contract')) {
    document.getElementById("formSection").style.display = "none";
    document.getElementById("contractSection").style.display = "block";
  }
  // Ensure initial active flag styling
  updateActiveFlag(currentLanguage);
});

function updateActiveFlag(lang) {
  document.querySelectorAll('[data-lang-btn]').forEach(btn => {
    btn.classList.toggle('active', btn.getAttribute('data-lang-btn') === lang);
  });
}

function changeLanguage(lang) {
  currentLanguage = lang;
  updateActiveFlag(lang);
  document.querySelectorAll('[data-es]').forEach(element => {
    if (element.tagName === 'INPUT' && element.type !== 'button' && element.type !== 'submit') {
      if (element.hasAttribute('placeholder')) {
        const placeholderText = element.getAttribute(`data-${lang}`) || element.getAttribute('data-es');
        element.setAttribute('placeholder', placeholderText);
      }
    } else {
      const text = element.getAttribute(`data-${lang}`) || element.getAttribute('data-es');
      element.textContent = text;
    }
  });
  document.querySelectorAll('.language-option').forEach(option => {
    option.classList.toggle('active', option.getAttribute('data-lang') === lang);
  });
  document.querySelectorAll('.optional').forEach(element => {
    const text = element.getAttribute(`data-${lang}`) || element.getAttribute('data-es');
    element.textContent = text;
  });
}

function generateContract() {
  const clientName = document.getElementById('clientName').value || "";
  const phone = document.getElementById('phone').value || "";
  if (!clientName || !phone) {
    alert(currentLanguage === 'es' ? "Por favor, proporcione al menos el nombre y el número de teléfono" : 
          currentLanguage === 'sv' ? "Vänligen ange åtminstone namn och telefonnummer" :
          "Please provide at least name and phone number");
    return;
  }
  const license = document.getElementById('license').value || "";
  const brand = document.getElementById('brand').value || "";
  const plate = document.getElementById('plate').value || "";
  const units = document.getElementById('units').value || "1";
  const from = document.getElementById('from').value || "";
  const to = document.getElementById('to').value || "";
  const total = document.getElementById('total').value || "";
  const iva = document.getElementById('iva').value || "";

  const np = currentLanguage === 'es' ? "No proporcionado" : currentLanguage === 'sv' ? "Inte angivet" : "Not provided";

  document.getElementById("showClientName").textContent = clientName || np;
  document.getElementById("showPhone").textContent = phone || np;
  document.getElementById("showLicense").textContent = license || np;
  document.getElementById("showBrand").textContent = brand || np;
  document.getElementById("showPlate").textContent = plate || np;
  document.getElementById("showUnits").textContent = units || "1";
  document.getElementById("showFrom").textContent = from || np;
  document.getElementById("showTo").textContent = to || np;
  document.getElementById("showTotal").textContent = total ? parseFloat(total).toFixed(2) : np;
  document.getElementById("showIVA").textContent = iva ? parseFloat(iva).toFixed(2) : np;

  document.getElementById("formSection").style.display = "none";
  document.getElementById("contractSection").style.display = "block";
  initSignaturePreview();
  updateUrl(clientName);
}

function initSignaturePreview() {
  const preview = document.getElementById("signaturePreview");
  preview.width = preview.offsetWidth;
  preview.height = 120;
  const pctx = preview.getContext("2d");
  pctx.clearRect(0, 0, preview.width, preview.height);
  pctx.strokeStyle = "#ccc";
  pctx.lineWidth = 1;
  pctx.setLineDash([5, 3]);
  pctx.strokeRect(0, 0, preview.width, preview.height);
  pctx.setLineDash([]);
  pctx.font = "14px Arial";
  pctx.fillStyle = "#999";
  pctx.textAlign = "center";
  const placeholderText = currentLanguage === 'es' ? "La firma aparecerá aquí" :
                          currentLanguage === 'sv' ? "Signaturen visas här" :
                          "Signature will appear here";
  pctx.fillText(placeholderText, preview.width/2, preview.height/2 + 5);
}

function openSignature() {
  document.getElementById("signatureModal").style.display = "flex";
  setupCanvas();
}
function closeSignature() { document.getElementById("signatureModal").style.display = "none"; }

function setupCanvas() {
  canvas = document.getElementById("signatureCanvas");
  ctx = canvas.getContext("2d");
  canvas.width = canvas.offsetWidth;
  canvas.height = 200;
  ctx.strokeStyle = "#000";
  ctx.lineWidth = 2;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';

  function getXY(e) {
    const rect = canvas.getBoundingClientRect();
    if(e.touches && e.touches.length>0) return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
    return { x: e.offsetX || (e.clientX - rect.left), y: e.offsetY || (e.clientY - rect.top) };
  }
  function startDraw(e){ drawing=true; const {x,y}=getXY(e); ctx.beginPath(); ctx.moveTo(x,y); e.preventDefault(); }
  function draw(e){ if(!drawing) return; const {x,y}=getXY(e); ctx.lineTo(x,y); ctx.stroke(); e.preventDefault(); }
  function stopDraw(e){ drawing=false; e.preventDefault(); }
  canvas.onmousedown = startDraw; canvas.onmousemove = draw; canvas.onmouseup = stopDraw; canvas.onmouseout = stopDraw;
  canvas.ontouchstart = startDraw; canvas.ontouchmove = draw; canvas.ontouchend = stopDraw;
  clearSignature();
}

function clearSignature() { if(ctx){ ctx.clearRect(0, 0, canvas.width, canvas.height); } }

function saveSignature() {
  const blank = document.createElement('canvas');
  blank.width = canvas.width; blank.height = canvas.height;
  if(canvas.toDataURL() === blank.toDataURL()) {
    alert(currentLanguage === 'es' ? "Por favor, proporcione su firma primero" : 
          currentLanguage === 'sv' ? "Vänligen ange din signatur först" :
          "Please provide your signature first");
    return;
  }
  signatureData = canvas.toDataURL();
  document.getElementById("signedStatus").style.display = "block";
  const preview = document.getElementById("signaturePreview");
  const pctx = preview.getContext("2d");
  preview.width = preview.offsetWidth; preview.height = 120;
  const img = new Image();
  img.onload = () => { pctx.clearRect(0, 0, preview.width, preview.height); pctx.drawImage(img, 0, 0, preview.width, preview.height); };
  img.src = signatureData;
  closeSignature();
}

function downloadPDF() {
  if(!signatureData) {
    alert(currentLanguage === 'es' ? "¡Por favor, firme el contrato primero!" : 
          currentLanguage === 'sv' ? "Vänligen signera kontraktet först!" :
          "Please sign the contract first!");
    return;
  }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(12);
  doc.text("NIF/CIF: B72700586", 10, 20);
  doc.text("NOMBRE: SIMON ABBOUD", 10, 27);
  doc.text("NIE: Y-6074507-Z", 10, 34);
  doc.text("Dirección: Calle Antonio Ruiz Corces 31", 10, 41);
  doc.text("Teléfono office: +34642482422", 10, 48);
  doc.text("Simón: +46735043440", 10, 55);
  doc.text("CONTRATO DE ALQUILER DE COCHES", 10, 70);
  const leftX = 10, rightX = 110, yStart = 85, lineHeight = 7;
  doc.text(`Cliente: ${document.getElementById('showClientName').textContent}`, leftX, yStart);
  doc.text(`Teléfono: ${document.getElementById('showPhone').textContent}`, leftX, yStart + lineHeight);
  doc.text(`Licencia: ${document.getElementById('showLicense').textContent}`, leftX, yStart + lineHeight*2);
  doc.text(`Marca del coche: ${document.getElementById('showBrand').textContent}`, leftX, yStart + lineHeight*3);
  doc.text(`Matrícula: ${document.getElementById('showPlate').textContent}`, leftX, yStart + lineHeight*4);
  doc.text(`Unidades: ${document.getElementById('showUnits').textContent}`, rightX, yStart);
  doc.text(`Fecha inicio: ${document.getElementById('showFrom').textContent}`, rightX, yStart + lineHeight);
  doc.text(`Fecha finalización: ${document.getElementById('showTo').textContent}`, rightX, yStart + lineHeight*2);
  doc.text(`IVA: ${document.getElementById('showIVA').textContent} €`, rightX, yStart + lineHeight*3);
  doc.text(`Precio Total: ${document.getElementById('showTotal').textContent} €`, rightX, yStart + lineHeight*4);
  let detailsEndY = yStart + lineHeight*4;
  let termsTitleY = detailsEndY + 15;
  doc.setFont(undefined, "bold");
  doc.text("Términos y Condiciones", 10, termsTitleY);
  doc.setFont(undefined, "normal");
  const terms = "Términos y condiciones:\n- Uso del vehículo: El vehículo no se utilizará con fines ilegales ni se conducirá bajo la influencia de drogas o alcohol.\n- Límite de edad: El inquilino confirma que tiene al menos 23 años. Los inquilinos menores de 23 años no son elegibles para alquilar ni conducir el automóvil.\n- Licencia de conducir: El inquilino debe tener una licencia de conducir válida y estar preparado para mostrarla en el momento del alquiler.\n- Restricciones geográficas: El arrendatario acepta que el vehículo sólo puede circular dentro de un radio de 250 km desde Torrevieja, España. Si desea circular fuera de esta zona, deberá obtener autorización previa por escrito.\n- Política de devolución: El vehículo debe devolverse en la fecha de finalización especificada en las mismas condiciones en que se recibió, excluyendo el desgaste normal. Las devoluciones tardías pueden estar sujetas a cargos adicionales.\n- Responsabilidad por Daños: Si el vehículo es conducido por un conductor menor de 23 años, ese conductor será personalmente responsable de cualquier daño al vehículo de alquiler y de cualquier daño a terceros.";
  const wrapped = doc.splitTextToSize(terms, 180);
  const termsBodyY = termsTitleY + 8;
  doc.text(wrapped, 10, termsBodyY);
  const afterTermsY = termsBodyY + wrapped.length * 6 + 8;
  doc.setFont(undefined, "bold");
  doc.text("Aceptación de Términos", 10, afterTermsY);
  doc.setFont(undefined, "normal");
  const acceptText = "Al firmar a continuación, ambas partes reconocen y aceptan todos los términos y condiciones de este contrato.";
  const acceptWrapped = doc.splitTextToSize(acceptText, 180);
  doc.text(acceptWrapped, 10, afterTermsY + 8);
  const sigLineY = afterTermsY + 8 + acceptWrapped.length * 6 + 30;
  doc.text("Firma del Cliente", 10, sigLineY - 20);
  doc.text("___________________________", 10, sigLineY);
  if (signatureData) {
    const sigWidth = 60;
    const sigX = 10 + (70 - sigWidth) / 2;
    doc.addImage(signatureData, 'PNG', sigX, sigLineY - 15, sigWidth, 15);
  }
  doc.text("___________________________", 130, sigLineY);
  doc.setFontSize(10);
  doc.text("SICARS", 145, sigLineY - 25);
  doc.text("ALQUILER - VENTA - COMPRA", 145, sigLineY - 20);
  doc.text("C/ Antonio Ruiz Covés N° 31", 145, sigLineY - 15);
  doc.text("03183 Torrevieja", 145, sigLineY - 10);
  doc.text("Y 6074507Z", 145, sigLineY - 5);
  doc.text("Tel. +34 642 482 422", 145, sigLineY);
  const clientName = document.getElementById('showClientName').textContent || "contrato";
  doc.save(`Contrato_${clientName.replace(/\s+/g,'_')}.pdf`);
}

function sendEmail() {
  const clientEmail = document.getElementById("clientEmail").value;
  if (!clientEmail) {
    alert(currentLanguage === 'es' ? "¡Por favor, ingrese su email!" : 
          currentLanguage === 'sv' ? "Vänligen ange din e-postadress!" :
          "Please enter your email!");
    return;
  }
  if (!signatureData) {
    alert(currentLanguage === 'es' ? "¡Por favor, firme el contrato primero!" : 
          currentLanguage === 'sv' ? "Vänligen signera kontraktet först!" :
          "Please sign the contract first!");
    return;
  }
  document.getElementById('emailLoading').style.display = 'block';
  document.getElementById('emailSuccess').style.display = 'none';
  document.getElementById('emailError').style.display = 'none';
  emailjs.send(
    'service_a709mgr',
    'template_2ifazx8',
    {
      client_name: document.getElementById('showClientName').textContent,
      phone: document.getElementById('showPhone').textContent,
      license: document.getElementById('showLicense').textContent,
      brand: document.getElementById('showBrand').textContent,
      plate: document.getElementById('showPlate').textContent,
      units: document.getElementById('showUnits').textContent,
      from_date: document.getElementById('showFrom').textContent,
      to_date: document.getElementById('showTo').textContent,
      total_cost: document.getElementById('showTotal').textContent,
      iva: document.getElementById('showIVA').textContent,
      signature: signatureData,
      to_email: clientEmail
    },
    'Ct6aXWOv0UiEYTK42'
  ).then(
    function() {
      document.getElementById('emailLoading').style.display = 'none';
      document.getElementById('emailSuccess').style.display = 'block';
      changeLanguage(currentLanguage);
    },
    function(error) {
      document.getElementById('emailLoading').style.display = 'none';
      document.getElementById('emailError').style.display = 'block';
      changeLanguage(currentLanguage);
      console.error(error);
    }
  );
}

window.generateContract = generateContract;
window.openSignature = openSignature;
window.closeSignature = closeSignature;
window.clearSignature = clearSignature;
window.saveSignature = saveSignature;
window.downloadPDF = downloadPDF;
window.sendEmail = sendEmail;
window.changeLanguage = changeLanguage;
window.goBackToForm = goBackToForm;
</script>
</body>
</html>
