<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sicars Car Rental Contract</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
  label { display: block; margin: 10px 0 5px; }
  input, select { padding: 8px; width: 100%; max-width: 300px; }
  button { margin-top: 10px; padding: 10px; cursor: pointer; border: none; border-radius: 5px; }
  .blue-btn { background: #007BFF; color: #fff; }
  .blue-btn:hover { background: #0056b3; }
  .red-btn { background: #FF4136; color: #fff; margin-top:20px; }
  .red-btn:hover { background: #c12b1f; }
  .contract { border: 1px solid #ccc; padding: 20px; margin-top: 20px; font-size: 14px; }
  .contract p { margin: 8px 0; }
  #signatureModal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
  .modal-content { background: #fff; padding: 20px; border-radius: 8px; text-align: center; max-width: 400px; width: 100%; }
  #signatureCanvas { border: 1px solid #000; width: 100%; height: 200px; touch-action: none; }
  /* Two-column layout */
  .two-columns { display: flex; justify-content: flex-start; margin-top: 15px; gap: 50px; }
  .col { width: 45%; }
</style>
</head>
<body>

<div id="formSection">
  <h2>Create Contract</h2>
  <label>Client Name:</label>
  <input type="text" id="clientName">

  <label>Phone Number:</label>
  <input type="tel" id="phone" pattern="[0-9]+" placeholder="Only numbers">

  <label>Driving License:</label>
  <input type="text" id="license">

  <label>Car Brand:</label>
  <input type="text" id="brand">

  <label>Car Plate Number:</label>
  <input type="text" id="plate">

  <label>Units:</label>
  <select id="units">
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
    <option value="6">6</option>
    <option value="7">7</option>
    <option value="8">8</option>
    <option value="9">9</option>
  </select>

  <label>Date From:</label>
  <input type="date" id="from">

  <label>Date To:</label>
  <input type="date" id="to">

  <label>IVA (€):</label>
  <input type="number" step="0.01" id="iva">

  <label>Total Cost (€):</label>
  <input type="number" step="0.01" id="total">

  <button class="blue-btn" onclick="generateContract()">Generate Contract</button>
</div>

<div id="contractSection" style="display:none;">
  <h2>Sicars Car Rental Contract</h2>
  <div class="contract" id="contractContent">

    <p><strong>NIF/CIF:</strong> B72700586</p>
    <p><strong>NOMBRE:</strong> SIMON ABBOUD</p>
    <p><strong>NIE:</strong> Y-6074507-Z</p>
    <p><strong>Dirección:</strong> Calle Antonio Ruiz Corces 31</p>
    <p><strong>Teléfono office:</strong> +34642482422</p>
    <p><strong>Simón:</strong> +46735043440</p>

    <h3>Rental Contract</h3>

    <div class="two-columns">
      <div class="col">
        <p><strong>Client:</strong> <span id="showClientName"></span></p>
        <p><strong>Phone:</strong> <span id="showPhone"></span></p>
        <p><strong>License:</strong> <span id="showLicense"></span></p>
        <p><strong>Car Brand:</strong> <span id="showBrand"></span></p>
        <p><strong>Plate:</strong> <span id="showPlate"></span></p>
      </div>

      <div class="col">
        <p><strong>Units:</strong> <span id="showUnits"></span></p>
        <p><strong>From:</strong> <span id="showFrom"></span></p>
        <p><strong>To:</strong> <span id="showTo"></span></p>
        <p><strong>IVA:</strong> €<span id="showIVA"></span></p>
        <p><strong>Total:</strong> €<span id="showTotal"></span></p>
      </div>
    </div>

    <h3>Terms & Conditions</h3>
    <p><strong>Uso del vehículo:</strong> El vehículo no se utilizará con fines ilegales ni se conducirá bajo la influencia de drogas o alcohol.</p>
    <p><strong>Límite de edad:</strong> El inquilino confirma que tiene al menos 23 años. Los inquilinos menores de 23 años no son elegibles para alquilar ni conducir el automóvil.</p>
    <p><strong>Licencia de conducir:</strong> El inquilino debe tener una licencia de conducir válida y estar preparado para mostrarla en el momento del alquiler.</p>
    <p><strong>Restricciones geográficas:</strong> El arrendatario acepta que el vehículo sólo puede circular dentro de un radio de 250 km desde Torrevieja, España. Si desea circular fuera de esta zona, deberá obtener autorización previa por escrito.</p>
    <p><strong>Política de devolución:</strong> El vehículo debe devolverse en la fecha de finalización especificada en las mismas condiciones en que se recibió, excluyendo el desgaste normal. Las devoluciones tardías pueden estar sujetas a cargos adicionales.</p>
    <p><strong>Responsabilidad por Daños:</strong> Si el vehículo es conducido por un conductor menor de 23 años, ese conductor será personalmente responsable de cualquier daño al vehículo de alquiler y de cualquier daño a terceros.</p>

    <h3>Aceptación de Términos</h3>
    <p>Al firmar a continuación, ambas partes reconocen y aceptan todos los términos y condiciones de este contrato.</p>
    <p>Firma</p>
    <canvas id="signaturePreview" style="border:1px solid #000; display:block; margin:10px 0; max-width:400px;"></canvas>
    <p>___________________________</p>

    <button class="blue-btn" onclick="openSignature()">✍️ Click here to sign</button>
    <p id="signedStatus" style="color:green;display:none;">✔ Signature captured</p>

    <label>Enter your email to receive the contract:</label>
    <input type="email" id="clientEmail" placeholder="your@email.com">
    <button class="blue-btn" onclick="sendEmail()">Send Contract via Email</button>
    <button class="red-btn" onclick="downloadPDF()">Download Contract as PDF</button>
  </div>
</div>

<!-- Signature Modal -->
<div id="signatureModal">
  <div class="modal-content">
    <h3>Draw Your Signature</h3>
    <canvas id="signatureCanvas"></canvas><br>
    <button onclick="clearSignature()">Clear</button>
    <button onclick="saveSignature()">Save</button>
    <button onclick="closeSignature()">Cancel</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
// Init EmailJS
emailjs.init("Ct6aXWOv0UiEYTK42");

let canvas, ctx, drawing = false, signatureData = null;

function generateContract() {
  const clientName = document.getElementById('clientName').value || "";
  const phone = document.getElementById('phone').value || "";
  const license = document.getElementById('license').value || "";
  const brand = document.getElementById('brand').value || "";
  const plate = document.getElementById('plate').value || "";
  const units = document.getElementById('units').value || "";
  const from = document.getElementById('from').value || "";
  const to = document.getElementById('to').value || "";
  const total = document.getElementById('total').value || "";
  const iva = document.getElementById('iva').value || "";

  document.getElementById("showClientName").textContent = clientName;
  document.getElementById("showPhone").textContent = phone;
  document.getElementById("showLicense").textContent = license;
  document.getElementById("showBrand").textContent = brand;
  document.getElementById("showPlate").textContent = plate;
  document.getElementById("showUnits").textContent = units;
  document.getElementById("showFrom").textContent = from;
  document.getElementById("showTo").textContent = to;
  document.getElementById("showTotal").textContent = total ? parseFloat(total).toFixed(2) : "";
  document.getElementById("showIVA").textContent = iva ? parseFloat(iva).toFixed(2) : "";

  document.getElementById("formSection").style.display = "none";
  document.getElementById("contractSection").style.display = "block";
}

function openSignature() {
  document.getElementById("signatureModal").style.display = "flex";
  setupCanvas();
}

function closeSignature() { document.getElementById("signatureModal").style.display = "none"; }

function setupCanvas() {
  canvas = document.getElementById("signatureCanvas");
  ctx = canvas.getContext("2d");
  canvas.width = canvas.offsetWidth;
  canvas.height = 200;
  ctx.strokeStyle = "#000";
  ctx.lineWidth = 2;

  function getXY(e) {
    const rect = canvas.getBoundingClientRect();
    if(e.touches && e.touches.length>0) return {x:e.touches[0].clientX-rect.left, y:e.touches[0].clientY-rect.top};
    return {x:e.offsetX, y:e.offsetY};
  }

  function startDraw(e){drawing=true;const {x,y}=getXY(e);ctx.beginPath();ctx.moveTo(x,y);e.preventDefault();}
  function draw(e){if(!drawing)return;const {x,y}=getXY(e);ctx.lineTo(x,y);ctx.stroke();e.preventDefault();}
  function stopDraw(e){drawing=false;e.preventDefault();}

  canvas.onmousedown=startDraw; canvas.onmousemove=draw; canvas.onmouseup=stopDraw; canvas.onmouseout=stopDraw;
  canvas.ontouchstart=startDraw; canvas.ontouchmove=draw; canvas.ontouchend=stopDraw;
}

function clearSignature() { if(ctx){ ctx.clearRect(0,0,canvas.width,canvas.height); } }

function saveSignature() {
  signatureData = canvas.toDataURL();
  document.getElementById("signedStatus").style.display = "block";

  const preview = document.getElementById("signaturePreview");
  const pctx = preview.getContext("2d");
  preview.width = preview.offsetWidth;
  preview.height = 100;
  const img = new Image();
  img.onload = () => { pctx.clearRect(0,0,preview.width,preview.height); pctx.drawImage(img,0,0,preview.width,preview.height); };
  img.src = signatureData;

  closeSignature();
}

function getContractTextForPDF() {
  const clientName = document.getElementById('showClientName').textContent || "";
  const phone = document.getElementById('showPhone').textContent || "";
  const license = document.getElementById('showLicense').textContent || "";
  const brand = document.getElementById('showBrand').textContent || "";
  const plate = document.getElementById('showPlate').textContent || "";
  const units = document.getElementById('showUnits').textContent || "";
  const from = document.getElementById('showFrom').textContent || "";
  const to = document.getElementById('showTo').textContent || "";
  const total = document.getElementById('showTotal').textContent || "";
  const iva = document.getElementById('showIVA').textContent || "";

  return `NIF/CIF: B72700586
NOMBRE: SIMON ABBOUD
NIE: Y-6074507-Z
Dirección: Calle Antonio Ruiz Corces 31
Teléfono office: +34642482422
Simón: +46735043440

CONTRATO DE ALQUILER DE COCHES

[Columna 1]
Cliente: ${clientName}
Teléfono: ${phone}
Licencia: ${license}
Marca del coche: ${brand}
Matrícula: ${plate}

[Columna 2]
Unidades: ${units}
Fecha inicio: ${from}
Fecha finalización: ${to}
IVA: €${iva}
Precio Total: €${total}

Términos y condiciones:
- Uso del vehículo: El vehículo no se utilizará con fines ilegales ni bajo drogas/alcohol.
- Límite de edad: mínimo 23 años.
- Licencia válida requerida.
- Restricción geográfica: 250 km desde Torrevieja salvo autorización.
- Devolución en fecha, en mismo estado.
- Menores de 23: responsables de daños.

Aceptación de términos:
Al firmar a continuación, ambas partes reconocen y aceptan todos los términos y condiciones de este contrato.
Firma
___________________________
`;
}

function downloadPDF() {
  if(!signatureData) { alert("Please sign the contract first!"); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(12);

  // Header info
  doc.text("NIF/CIF: B72700586", 10, 20);
  doc.text("NOMBRE: SIMON ABBOUD", 10, 27);
  doc.text("NIE: Y-6074507-Z", 10, 34);
  doc.text("Dirección: Calle Antonio Ruiz Corces 31", 10, 41);
  doc.text("Teléfono office: +34642482422", 10, 48);
  doc.text("Simón: +46735043440", 10, 55);

  doc.text("CONTRATO DE ALQUILER DE COCHES", 10, 70);

  // Two-column layout in PDF
  const leftX = 10, rightX = 110, yStart = 85, lineHeight = 7;

  doc.text(`Cliente: ${document.getElementById('showClientName').textContent}`, leftX, yStart);
  doc.text(`Teléfono: ${document.getElementById('showPhone').textContent}`, leftX, yStart + lineHeight);
  doc.text(`Licencia: ${document.getElementById('showLicense').textContent}`, leftX, yStart + lineHeight*2);
  doc.text(`Marca del coche: ${document.getElementById('showBrand').textContent}`, leftX, yStart + lineHeight*3);
  doc.text(`Matrícula: ${document.getElementById('showPlate').textContent}`, leftX, yStart + lineHeight*4);

  doc.text(`Unidades: ${document.getElementById('showUnits').textContent}`, rightX, yStart);
  doc.text(`Fecha inicio: ${document.getElementById('showFrom').textContent}`, rightX, yStart + lineHeight);
  doc.text(`Fecha finalización: ${document.getElementById('showTo').textContent}`, rightX, yStart + lineHeight*2);
  doc.text(`IVA: €${document.getElementById('showIVA').textContent}`, rightX, yStart + lineHeight*3);
  doc.text(`Precio Total: €${document.getElementById('showTotal').textContent}`, rightX, yStart + lineHeight*4);

  // Terms & Conditions in PDF
  let detailsEndY = Math.max(yStart + lineHeight*4, yStart + lineHeight*4);
  let termsTitleY = detailsEndY + 15;
  doc.setFont(undefined, "bold");
  doc.text("Términos & Condiciones", 10, termsTitleY);
  doc.setFont(undefined, "normal");

  const terms = "Términos y condiciones:\n- Uso del vehículo: El vehículo no se utilizará con fines ilegales ni se conducirá bajo la influencia de drogas o alcohol.\n- Límite de edad: El inquilino confirma que tiene al menos 23 años. Los inquilinos menores de 23 años no son elegibles para alquilar ni conducir el automóvil.\n- Licencia de conducir: El inquilino debe tener una licencia de conducir válida y estar preparado para mostrarla en el momento del alquiler.\n- Restricciones geográficas: El arrendatario acepta que el vehículo sólo puede circular dentro de un radio de 250 km desde Torrevieja, España. Si desea circular fuera de esta zona, deberá obtener autorización previa por escrito.\n- Política de devolución: El vehículo debe devolverse en la fecha de finalización especificada en las mismas condiciones en que se recibió, excluyendo el desgaste normal. Las devoluciones tardías pueden estar sujetas a cargos adicionales.\n- Responsabilidad por Daños: Si el vehículo es conducido por un conductor menor de 23 años, ese conductor será personalmente responsable de cualquier daño al vehículo de alquiler y de cualquier daño a terceros.";

  const wrapped = doc.splitTextToSize(terms, 180);
  const termsBodyY = termsTitleY + 8;
  doc.text(wrapped, 10, termsBodyY);

  // Acceptance + signature
  const afterTermsY = termsBodyY + wrapped.length * 6 + 8;
  doc.setFont(undefined, "bold");
  doc.text("Aceptación de Términos", 10, afterTermsY);
  doc.setFont(undefined, "normal");
  const acceptText = "Al firmar a continuación, ambas partes reconocen y aceptan todos los términos y condiciones de este contrato.";
  const acceptWrapped = doc.splitTextToSize(acceptText, 180);
  doc.text(acceptWrapped, 10, afterTermsY + 8);

  // Signature line and image
  const sigLineY = afterTermsY + 8 + acceptWrapped.length * 6 + 30; // Moved line and signature further down
  doc.text("Firma", 10, sigLineY - 20); // "Firma" text moved up for distance
  doc.text("___________________________", 10, sigLineY); // Line at new position
  if (signatureData) {
    doc.addImage(signatureData, 'PNG', 10, sigLineY - 15, 60, 15); // Signature just above the line
  }

  const clientName = document.getElementById('showClientName').textContent || "contract";
  doc.save(`Contract_${clientName.replace(/\s+/g,'_')}.pdf`);
}

function sendEmail() {
  const clientEmail = document.getElementById("clientEmail").value;
  if (!clientEmail) {
    alert("Please enter your email!");
    return;
  }

  emailjs.send(
    'service_a709mgr',
    'template_2ifazx8',
    {
      client_name: document.getElementById('showClientName').textContent,
      phone: document.getElementById('showPhone').textContent,
      license: document.getElementById('showLicense').textContent,
      brand: document.getElementById('showBrand').textContent,
      plate: document.getElementById('showPlate').textContent,
      units: document.getElementById('showUnits').textContent,
      from_date: document.getElementById('showFrom').textContent,
      to_date: document.getElementById('showTo').textContent,
      total_cost: document.getElementById('showTotal').textContent,
      iva: document.getElementById('showIVA').textContent,
      signature: signatureData,
      to_email: clientEmail
    },
    'Ct6aXWOv0UiEYTK42'
  ).then(
    function(response) { alert("Contract sent successfully!"); },
    function(error) { alert("Failed to send contract. Try again."); console.error(error); }
  );
}

// Ensure functions exist on window for inline onclick handlers
window.generateContract = generateContract;
window.openSignature = openSignature;
window.closeSignature = closeSignature;
window.clearSignature = clearSignature;
window.saveSignature = saveSignature;
window.downloadPDF = downloadPDF;
window.sendEmail = sendEmail;
</script>
</body>
</html>
